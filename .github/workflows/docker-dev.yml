name: Build and Push Docker Image (Development)

on:
  push:
    branches:
      - develop

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: self-hosted
    steps:
      - name: ğŸ§© Load .env from absolute path
        run: |
          # ğŸ‘‡ Define absolute path to your .env file
          ENV_FILE="/home/ubuntu/borhan/whole_pipeline/vexu/call_Agent/.env"

          # Set fallback defaults
          HOST_DEFAULT="0.0.0.0"
          PORT_DEFAULT="8000"

          export HOST="$HOST_DEFAULT"
          export PORT="$PORT_DEFAULT"

          # Check if .env exists at that path
          if [ -f "$ENV_FILE" ]; then
            echo "âœ… .env found at $ENV_FILE â€” loading variables..."
            set -a
            source "$ENV_FILE"
            set +a
          else
            echo "âš ï¸ .env not found at $ENV_FILE â€” using defaults: HOST=$HOST_DEFAULT, PORT=$PORT_DEFAULT"
          fi

          # Validate
          if [ -z "$HOST" ] || [ -z "$PORT" ]; then
            echo "âŒ Error: HOST or PORT is not set (even after fallback)"
            exit 1
          fi

          echo "ğŸ“Œ Final config: HOST=$HOST, PORT=$PORT"

          # Save to GITHUB_ENV
          echo "HOST=$HOST" >> $GITHUB_ENV
          echo "PORT=$PORT" >> $GITHUB_ENV

      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4


      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build --no-cache -t orchestrator-server:latest .
      
      - name: Stop and remove previous container (optional)
        run: |
          if [ $(docker ps -a -q -f name=orchestrator-server-container) ]; then
            docker stop orchestrator-server-container || true
            docker rm orchestrator-server-container || true
          fi
      
      - name: ğŸ§¹ Remove existing container by name (if exists)
        run: |
          CONTAINER_NAME="orchestrator-server-container"
          if [ $(docker ps -a -q -f name=^/${CONTAINER_NAME}$) ]; then
            echo "âš ï¸ Container '$CONTAINER_NAME' exists. Stopping and removing..."
            docker stop $CONTAINER_NAME 2>/dev/null || true
            docker rm $CONTAINER_NAME 2>/dev/null || true
            echo "âœ… Container '$CONTAINER_NAME' removed."
          else
            echo "âœ… No existing container named '$CONTAINER_NAME' found."
          fi
      
      
      - name: ğŸ’£ğŸ’£ KILL ALL PROCESSES USING PORT ${{ env.PORT }} â€” FOR REAL
        run: |
          PORT=${{ env.PORT }}
          echo "ğŸ“¡ Scanning for ALL processes using port $PORT..."
          
          # Get ALL PIDs using this port (listeners AND connected clients)
          PIDS=$(lsof -ti :$PORT) || true
          
          if [ -n "$PIDS" ]; then
            echo "ğŸ§¨ Found the following PIDs: $PIDS"
            echo "ğŸ“œ Details:"
            lsof -i :$PORT
            
            # Kill them ALL, one by one
            for PID in $PIDS; do
              echo "ğŸ’€ Killing PID $PID..."
              kill -9 $PID 2>/dev/null && echo "âœ… Killed $PID" || echo "âš ï¸ Failed to kill $PID"
            done
            
            # Wait for processes to die
            sleep 5
            
            # DOUBLE CHECK â€” if anything remains, KILL AGAIN
            LEFTOVER_PIDS=$(lsof -ti :$PORT) || true
            if [ -n "$LEFTOVER_PIDS" ]; then
              echo "â˜¢ï¸  STILL ALIVE â€” Nuclear option: kill -9 again!"
              for PID in $LEFTOVER_PIDS; do
                echo "â˜ ï¸  Final kill for PID $PID..."
                kill -9 $PID 2>/dev/null && echo "âœ… Confirmed dead" || echo "ğŸ’€ Unkillable? Check manually."
              done
              sleep 3
            fi
            
            # Final verification
            if lsof -i :$PORT > /dev/null 2>&1; then
              echo "âŒâŒâŒ EMERGENCY: Port $PORT is STILL in use after multiple kills. Manual intervention required."
              echo "ğŸ“‹ Run this manually on the host:"
              echo "   sudo lsof -i :${{ env.PORT }}"
              echo "   sudo kill -9 <PID>"
              exit 1
            else
              echo "âœ…âœ…âœ… Port $PORT is now 100% FREE. Proceeding..."
            fi
          else
            echo "âœ… Port $PORT is free â€” nothing to kill."
          fi
      
      - name: Run Docker container
        run: |
          echo "Starting container with HOST=${{ env.HOST }} PORT=${{ env.PORT }}"
          docker run -d \
            --gpus all \
            --name orchestrator-server-container \
            --restart unless-stopped \
            -p ${{ env.PORT }}:8000 \
            orchestrator-server:latest
      
            
      - name: ğŸ§¹ Cleanup old Docker images
        run: |
          echo "ğŸ§¹ Removing dangling images..."
          sudo docker container prune -f
          docker image prune -f
      
      
      - name: Show running containers
        run: docker ps

      - name: Output container logs (optional, for debugging)
        run: |
          sleep 5
          docker logs orchestrator-server-container


  
  
  pushing_to_mehdi_origin:
    runs-on: self-hosted
    steps:
      - name: ğŸ”„ Push to Mehdi's Repository
        run: |
          # Only push if remote "mehdi" exists
          if git remote | grep -q '^mehdi$'; then
            echo "âœ… Remote 'mehdi' found â€” pushing..."
            git push mehdi develop
          else
            echo "âš ï¸ Remote 'mehdi' not found â€” skipping push."
          fi
